(function(E,I){typeof exports=="object"&&typeof module<"u"?I(exports):typeof define=="function"&&define.amd?define(["exports"],I):(E=typeof globalThis<"u"?globalThis:E||self,I(E["@hcmus-toolkit/core"]={}))})(this,(function(E){"use strict";const I={"1/24-25":{theory:{start:new Date("2024-09-30T00:00:00Z"),end:new Date("2024-12-15T00:00:00Z")},practice:{start:new Date("2024-10-07T00:00:00Z"),end:new Date("2024-12-15T00:00:00Z")},breaks:[{start:new Date("2024-11-04T00:00:00Z"),end:new Date("2024-11-10T00:00:00Z")}]},"2/24-25":{theory:{start:new Date("2025-01-06T00:00:00Z"),end:new Date("2025-04-13T00:00:00Z")},practice:{start:new Date("2025-01-13T00:00:00Z"),end:new Date("2025-04-13T00:00:00Z")},breaks:[{start:new Date("2025-01-20T00:00:00Z"),end:new Date("2025-02-09T00:00:00Z")},{start:new Date("2025-03-03T00:00:00Z"),end:new Date("2025-03-09T00:00:00Z")}]},"3/24-25":{theory:{start:new Date("2025-05-12T00:00:00Z"),end:new Date("2025-08-17T00:00:00Z")},practice:{start:new Date("2025-05-19T00:00:00Z"),end:new Date("2025-08-17T00:00:00Z")},breaks:[{start:new Date("2025-06-16T00:00:00Z"),end:new Date("2025-07-13T00:00:00Z")}]},"1/25-26":{theory:{start:new Date("2025-10-06T00:00:00Z"),end:new Date("2025-12-13T00:00:00Z")},practice:{start:new Date("2025-10-13T00:00:00Z"),end:new Date("2025-12-13T00:00:00Z")},breaks:[{start:new Date("2025-11-10T00:00:00Z"),end:new Date("2025-11-15T00:00:00Z")}]},"2/25-26":{theory:{start:new Date("2026-01-12T00:00:00Z"),end:new Date("2026-04-18T00:00:00Z")},practice:{start:new Date("2026-01-19T00:00:00Z"),end:new Date("2026-04-18T00:00:00Z")},breaks:[{start:new Date("2026-02-09T00:00:00Z"),end:new Date("2026-02-28T00:00:00Z")},{start:new Date("2026-03-09T00:00:00Z"),end:new Date("2026-03-14T00:00:00Z")}]},"3/25-26":{theory:{start:new Date("2025-05-18T00:00:00Z"),end:new Date("2025-08-22T00:00:00Z")},practice:{start:new Date("2025-05-25T00:00:00Z"),end:new Date("2025-08-22T00:00:00Z")},breaks:[{start:new Date("2025-06-22T00:00:00Z"),end:new Date("2025-07-11T00:00:00Z")}]}},C="Asia/Ho_Chi_Minh",x=["T2","T3","T4","T5","T6","T7","CN"],j=new Intl.DateTimeFormat("vi-VN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1,timeZone:"UTC"}),N=new Intl.DateTimeFormat("vi-VN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1,timeZone:C});function S(T,r){const t={};for(const o of r.formatToParts(T))t[o.type]=o.value;return`${t.year}${t.month}${t.day}T${t.hour}${t.minute}${t.second}`}const L=async()=>{if(!$.alert){const e=document.createElement("link");Object.assign(e,{rel:"stylesheet",type:"text/css"});const a=new Promise(i=>e.addEventListener("load",i));e.href="/plugins/jquery-confirm/dist/jquery-confirm.min.css",document.head.appendChild(e);const n=document.createElement("script"),s=new Promise(i=>n.addEventListener("load",i));n.src="/plugins/jquery-confirm/dist/jquery-confirm.min.js",document.head.appendChild(n),await Promise.all([a,s])}const T="hcmus-calendar",r="HCMUS Timetable Exporter",t=/<\s*br\s*(?:\/\s*)?>/gu;function o(e,a=0){const n=e.length;let s=75-a,i=e.substring(0,75-a);for(;s<n;){const c=e.substring(s,s+75);i+=`\r
 ${c}`,s+=75}return i}function*m(e){const a=e.split(t);for(const n of a){const s=n.match(/(?<dow>T[2-7]|CN) (?<start>\d{1,2}:\d{1,2})-(?<end>\d{1,2}:\d{1,2}) (?:\((?<class>.+?)\))?/);if(!s||s.length!==5)throw new Error(`Schedule was not in correct format: ${n}`);const[i,c,u,M,R]=s,l=x.indexOf(c);if(l===-1)throw new Error(`Unknown weekday: ${c}`);const y=u.split(":").map(Number),g=M.split(":").map(Number);if(y.length!==2)throw new Error(`Cannot parse start hour: ${u}`);if(g.length!==2)throw new Error(`Cannot parse end time: ${M}`);yield{weekday:l,startHm:y,endHm:g,location:R??null}}}/**
 * @source @bkalendar/core
 * @license MIT
 * Copyright (c) 2022 BKalendar
 */function v(e,a,n){return new Date(+a+n*864e5+(e[0]-7)*36e5+e[1]*6e4)}function O(e,a){const n=new Date(e.valueOf());return n.setDate(e.getDate()+a),n}/**
 * @source @bkalendar/core
 * @license MIT
 * Copyright (c) 2022 BKalendar
 */function p(e,a,n,s=[]){const i=Object.entries(e.extras),c=[];if(i.length!==0){const l=i.map(([y,g])=>`${y}: ${g}`).join("\\n");c.push(`DESCRIPTION:${o(l,13)}`)}const u=[`RRULE:FREQ=WEEKLY;UNTIL=${S(n,j)}`],M=v(e.startHm,a,e.weekday);if(s.length>0){let l=M,y=0;for(;l<n;)s.some(g=>g.start<=l&&l<=g.end)&&(y===0?(u.push(`EXDATE;TZID=${C}`),u.push(` :${S(l,N)}`)):u.push(` ,${S(l,N)}`),y++),l=O(l,7)}const R=["BEGIN:VEVENT",`UID:${crypto.randomUUID()}@${T}`,`DTSTAMP:${S(new Date,j)}`,`SUMMARY:${o(e.name,9)}`,...c];return e.location!==null&&R.push(`LOCATION:${o(e.location,10)}`),R.push(`DTSTART;TZID=${C}:${S(v(e.startHm,a,e.weekday),N)}`,`DTEND;TZID=${C}:${S(v(e.endHm,a,e.weekday),N)}`,...u,"END:VEVENT"),R}function H(e){const a=document.createElement("div");a.innerHTML=e;const n=a.textContent;return a.remove(),n??""}if(document.location.pathname!=="/sinh-vien/ket-qua-dkhp"){$.alert({type:"red",title:"Wrong location",content:"You are in the wrong place. To export your timetable, go to https://portal.ctdb.hcmus.edu.vn/sinh-vien/ket-qua-dkhp.",buttons:{ok:{text:"Take me there",btnClass:"btn-blue",action:()=>{document.location="/sinh-vien/ket-qua-dkhp"}},cancel:{text:"Cancel"}}});return}const D=document.querySelector(".ModCTDBSVKetQuaDKHPC");if(!D){$.alert({type:"red",title:"Could not find timetable",content:'Cannot export timetable if it does not exist. If you think this is an error, please <a href="https://github.com/beerpiss/hcmus-ctda-calendar/issues">contact the developer</a>.',buttons:{ok:{text:"OK"}}});return}const b=ko.dataFor(D),f=b.dsKetQuaDKHP();if(console.log(`ketQuaDKHP: ${JSON.stringify(f)}`),f.length===0){$.alert({title:"Nothing to export",content:'Seems like you have no subjects this semester. Have fun! If you think this is an error, please <a href="https://github.com/beerpiss/hcmus-ctda-calendar/issues">contact the developer</a>.',buttons:{ok:{text:"OK"}}});return}const h=["BEGIN:VCALENDAR",`PRODID:-//${T}//${r}//VI`,"VERSION:2.0","BEGIN:VTIMEZONE","TZID:Asia/Ho_Chi_Minh","TZURL:http://tzurl.org/zoneinfo-outlook/Asia/Ho_Chi_Minh","X-LIC-LOCATION:Asia/Ho_Chi_Minh","BEGIN:STANDARD","TZOFFSETFROM:+0700","TZOFFSETTO:+0700","TZNAME:+07","DTSTART:19700101T000000","END:STANDARD","END:VTIMEZONE"];for(const e of f){if(!e.LichHocLT&&!e.LichHocTH)continue;let a=null;const n=I[e.HocKy];if(!n){$.alert({type:"red",title:"Error",content:`Start and end dates for semester ${e.HocKy} has not been added. Please <a href="https://github.com/beerpiss/hcmus-ctda-calendar/issues">contact the developer</a>.`,buttons:{ok:{text:"OK"}}});return}const s={};if(e.GVTroGiang&&(s["Trợ giảng"]=e.GVTroGiang.replace(t,", ")),e.GhiChu&&(s["Ghi chú"]=H(e.GhiChu).replace(/^Ghi chú:\s*/,"")),e.LichHocLT){const i=`[${e.KyHieu}] [LT] ${e.TenMH}`,c={};e.GVLyThuyet&&(c["Giáo viên"]=e.GVLyThuyet.replace(t,", ")),Object.assign(c,s);for(const u of m(e.LichHocLT))a={...u,name:i,extras:c},h.push(...p(a,n.theory.start,n.theory.end,n.breaks))}if(e.LichHocTH){const i=`[${e.KyHieu}] [TH] ${e.TenMH}`,c={};e.GVThucHanh&&(c["Giáo viên"]=e.GVThucHanh.replace(t,", ")),Object.assign(c,s);for(const u of m(e.LichHocTH))a={...u,name:i,extras:c},h.push(...p(a,n.practice.start,n.practice.end,n.breaks))}}h.push("END:VCALENDAR");const Z=h.join(`\r
`),k=b.selectedMaHK(),w=b.dsHocKy().find(e=>e.MaHK===k),G=w?`${w.TenHK}.ics`:"Unknown Semester.ics",A=document.createElement("a");A.href=`data:text/calendar,${encodeURIComponent(Z)}`,A.download=G,A.click(),A.remove(),toastr.success("The timetable was successfully exported.")};class K{$fetch;constructor(r){this.$fetch=r}async call(r,t,{body:o,options:m}={}){return this.$fetch(r,{method:t,body:o,...m})}}class P extends K{RESOURCE="https://portal.ctdb.hcmus.edu.vn/dang-ky-hoc-phan";HEADERS={Cookie:document.cookie,"X-OFFICIAL-REQUEST":"TRUE","X-Requested-With":"XMLHttpRequest"};getResourceUrl(...r){return this.RESOURCE+(r.length>0?`/${r.join("/")}`:"")}async addSubject(r,t){const o=new FormData;return o.append("action","addMonDangKy"),o.append("data",t.toString()),this.call(this.getResourceUrl(`sinh-vien-${r}`),"POST",{body:o,options:{headers:{...this.HEADERS}}})}async removeSubject(r,t){const o=new FormData;return o.append("action","delMonDangKy"),o.append("data",t.toString()),this.call(this.getResourceUrl(`sinh-vien-${r}`),"POST",{body:o,options:{headers:{...this.HEADERS}}})}async getSubjectList(r,t){const o=new FormData;return o.append("action","loadDangKyHocPhan"),o.append("data",t.toString()),this.call(this.getResourceUrl(`sinh-vien-${r}`),"POST",{body:o,options:{headers:{...this.HEADERS}}})}}const U=async(T,...r)=>{if(!["apcs","clc"].map(D=>`/dang-ky-hoc-phan/sinh-vien-${D}`).includes(T))return;const t=document.querySelector(".ModCTDBDKHocPhanC");if(!t)return;const o=t.querySelector("#divMonChuaDK table tbody");if(!o)return;const m=ko.dataFor(t);if(!m)return;new MutationObserver(D=>{for(const b of D)for(const f of b.addedNodes){if(f.nodeName!=="TR")continue;const h=f,Z=h.querySelectorAll("td")[1];if(!Z)continue;const k=ko.dataFor(h);Z.textContent+=` (${k.MaMG})`}}).observe(o,{childList:!0});let O=0;const p=document.createElement("textarea");p.placeholder="Enter internal subject IDs (shown in parentheses) separated by whitespace.",p.value=localStorage.getItem("registeredSubjectIDs")??"",p.addEventListener("keyup",()=>{O&&clearTimeout(O),O=setTimeout(()=>{localStorage.setItem("registeredSubjectIDs",p.value)},1e3)});const H=document.createElement("button");H.textContent="Bulk register subjects",H.onclick=async D=>{D.preventDefault();const b=p.value.split(/\s+/gu).map(d=>Number(d)).concat(r.map(d=>Number(d))),f=m.dsChuaDangKy().map(d=>d.MaMG),h=b.filter(d=>f.includes(d));if(h.length===0){toastr.warning("No valid subjects entered.");return}const Z=T.split("-").pop(),k=await Promise.allSettled(h.map(d=>new P(fetch).addSubject(Z,d)));if(m.loadDangKyHocPhan(),k.some(d=>d.status==="rejected")){const d=k.filter(w=>w.status==="rejected").map(w=>w.reason.Message);$.alert({type:"red",title:"Could not register some subjects",content:d.join("<br>"),buttons:{ok:{text:"Ok"}}})}else toastr.success("Successfully registered subjects.")},t.querySelector(".panel .panel-body")?.insertAdjacentElement("beforeend",p),t.querySelector(".panel .panel-body")?.insertAdjacentElement("beforeend",document.createElement("br")),t.querySelector(".panel .panel-body")?.insertAdjacentElement("beforeend",H),localStorage.getItem("registeredSubjectIDs")&&m.ok()&&setTimeout(()=>H.click(),1500)};E.autoRegistration=U,E.exportTimetable=L,Object.defineProperty(E,Symbol.toStringTag,{value:"Module"})}));
